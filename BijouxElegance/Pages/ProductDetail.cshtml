@page "{id:int}"
@model BijouxElegance.Pages.ProductDetailModel
@{
    ViewData["Title"] = Model.Product.Name;
}

<div class="container py-5">
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-success">
            @TempData["Message"]
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <img src="@Model.Product.ImageUrl" class="img-fluid rounded" alt="@Model.Product.Name">
        </div>
        <div class="col-md-6">
            <h1>@Model.Product.Name</h1>
            <p class="text-muted">Catégorie: @Model.Product.Category.Name</p>
            <p>@Model.Product.Description</p>

            <h2 class="price">@Model.Product.Price.ToString("C")</h2>

            <div class="mt-4">
                <div class="mb-3">
                    <label for="quantity" class="form-label">Quantité:</label>
                    <input type="number" id="quantity" name="quantity" class="form-control"
                           value="1" min="1" max="@Model.Product.StockQuantity" style="width: 100px;">
                </div>
                <button class="btn btn-gold btn-lg" onclick="addToCart(@Model.Product.ProductId)">
                    <i class="fas fa-shopping-cart"></i> Ajouter au panier
                </button>
                <a href="/" class="btn btn-outline-secondary btn-lg">Continuer mes achats</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Gestionnaire de panier localStorage
        const CartManager = {
            getCart: function() {
                try {
                    const cartJson = localStorage.getItem('bijoux-cart');
                    return cartJson ? JSON.parse(cartJson) : [];
                } catch {
                    return [];
                }
            },

            saveCart: function(cart) {
                localStorage.setItem('bijoux-cart', JSON.stringify(cart));
                this.updateCartCount();
            },

            addItem: function(productId, quantity = 1) {
                let cart = this.getCart();
                const existing = cart.find(item => item.productId == productId);

                if (existing) {
                    existing.quantity += quantity;
                } else {
                    cart.push({
                        productId: productId,
                        quantity: quantity,
                        addedAt: new Date().toISOString()
                    });
                }

                this.saveCart(cart);
                return cart;
            },

            updateCartCount: function() {
                const cart = this.getCart();
                const count = cart.reduce((total, item) => total + item.quantity, 0);

                // Mettre à jour tous les éléments avec la classe cart-count
                document.querySelectorAll('.cart-count').forEach(el => {
                    if (count > 0) {
                        el.textContent = count;
                        el.style.display = 'inline-block';
                    } else {
                        el.style.display = 'none';
                    }
                });

                return count;
            }
        };

        async function addToCart(productId) {
            const quantityInput = document.getElementById('quantity');
            const quantity = parseInt(quantityInput.value) || 1;

            try {
                // Ajouter au localStorage
                CartManager.addItem(productId, quantity);

                // Notifier l'utilisateur
                showNotification('Produit ajouté au panier !', 'success');

                // Si utilisateur connecté, synchroniser avec le serveur
                try {
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            productId: productId,
                            quantity: quantity
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Ajout réussi:', data);
                    }
                } catch (serverError) {
                    console.log('Utilisateur non connecté ou erreur serveur:', serverError);
                }

            } catch (error) {
                console.error('Erreur ajout panier:', error);
                showNotification('Erreur lors de l\'ajout au panier', 'danger');
            }
        }

        function showNotification(message, type = 'info') {
            // Créer une notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 1050;
                min-width: 300px;
            `;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto-suppression après 3 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Initialiser le compteur au chargement
        document.addEventListener('DOMContentLoaded', function() {
            CartManager.updateCartCount();
        });
    </script>
}